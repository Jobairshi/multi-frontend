<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Layered Cache Stress Test Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .control-group h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 120px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-card h4 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .metric-card .value {
            font-size: 2em;
            font-weight: bold;
        }

        .metric-card .unit {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .results {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .results h3 {
            color: #495057;
            margin-bottom: 15px;
        }

        .log {
            background: #212529;
            color: #00ff00;
            padding: 15px;
            border-radius: 6px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .log .timestamp {
            color: #6c757d;
        }

        .log .success {
            color: #28a745;
        }

        .log .error {
            color: #dc3545;
        }

        .log .info {
            color: #17a2b8;
        }

        .log .warning {
            color: #ffc107;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .chart {
            width: 100%;
            height: 300px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Multi-Layered Cache Stress Test Tool</h1>
            <p>Test Redis ‚Üí CDN ‚Üí Browser caching layers</p>
        </div>

        <div class="content">
            <!-- Configuration Panel -->
            <div class="control-panel">
                <!-- API Configuration -->
                <div class="control-group">
                    <h3>üîß API Configuration</h3>
                    <div class="form-group">
                        <label>API Base URL</label>
                        <input type="text" id="apiUrl" value="http://localhost:8080" placeholder="http://localhost:8080">
                    </div>
                    <div class="form-group">
                        <label>Frontend URL</label>
                        <input type="text" id="frontendUrl" value="http://localhost:3000" placeholder="http://localhost:3000">
                    </div>
                    <div class="form-group">
                        <label>Auth Token (optional)</label>
                        <input type="text" id="authToken" placeholder="Your JWT token">
                    </div>
                </div>

                <!-- Test Configuration -->
                <div class="control-group">
                    <h3>‚öôÔ∏è Test Configuration</h3>
                    <div class="form-group">
                        <label>Concurrent Requests</label>
                        <input type="number" id="concurrent" value="10" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label>Total Requests</label>
                        <input type="number" id="totalRequests" value="100" min="1" max="10000">
                    </div>
                    <div class="form-group">
                        <label>Delay Between Batches (ms)</label>
                        <input type="number" id="delay" value="100" min="0" max="5000">
                    </div>
                    <div class="form-group">
                        <label>Test Type</label>
                        <select id="testType">
                            <option value="all">All Endpoints</option>
                            <option value="read">Read Only (GET /news)</option>
                            <option value="single">Single Article (GET /news/:id)</option>
                            <option value="create">Create Articles (POST /news)</option>
                            <option value="mixed">Mixed Operations</option>
                            <option value="cache-bust">Cache Busting Test</option>
                        </select>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="control-group">
                    <h3>‚ö° Quick Actions</h3>
                    <div class="button-group">
                        <button class="btn-success" onclick="startTest()">‚ñ∂Ô∏è Start Test</button>
                        <button class="btn-danger" onclick="stopTest()">‚èπÔ∏è Stop</button>
                        <button class="btn-warning" onclick="resetMetrics()">üîÑ Reset</button>
                    </div>
                    <div class="button-group" style="margin-top: 10px;">
                        <button class="btn-info" onclick="testRedisCache()">Test Redis</button>
                        <button class="btn-info" onclick="testCDNCache()">Test CDN</button>
                        <button class="btn-info" onclick="testBrowserCache()">Test Browser</button>
                    </div>
                    <div class="button-group" style="margin-top: 10px;">
                        <button class="btn-primary" onclick="exportResults()">üìä Export JSON</button>
                        <button class="btn-primary" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%">0%</div>
            </div>

            <!-- Metrics Dashboard -->
            <div class="metrics" id="metrics">
                <div class="metric-card">
                    <h4>Total Requests</h4>
                    <div class="value" id="totalReqs">0</div>
                </div>
                <div class="metric-card">
                    <h4>Success Rate</h4>
                    <div class="value" id="successRate">0%</div>
                </div>
                <div class="metric-card">
                    <h4>Avg Response Time</h4>
                    <div class="value" id="avgTime">0<span class="unit">ms</span></div>
                </div>
                <div class="metric-card">
                    <h4>Requests/Second</h4>
                    <div class="value" id="reqPerSec">0</div>
                </div>
                <div class="metric-card">
                    <h4>Cache Hit Ratio</h4>
                    <div class="value" id="cacheHitRatio">0%</div>
                </div>
                <div class="metric-card">
                    <h4>Failed Requests</h4>
                    <div class="value" id="failedReqs">0</div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="results">
                <h3>üìã Test Results & Logs</h3>
                <div class="log" id="log">
                    <div class="info">[INFO] Stress test tool initialized. Configure settings and click Start Test.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Test state
        let testRunning = false;
        let testResults = {
            totalRequests: 0,
            successfulRequests: 0,
            failedRequests: 0,
            responseTimes: [],
            cacheHits: 0,
            cacheMisses: 0,
            errors: [],
            startTime: null,
            endTime: null,
        };

        // Utility: Log message
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type.toLowerCase();
            const line = `<div class="${className}"><span class="timestamp">[${timestamp}]</span> ${message}</div>`;
            logEl.innerHTML += line;
            logEl.scrollTop = logEl.scrollHeight;
        }

        // Utility: Update metrics
        function updateMetrics() {
            const { totalRequests, successfulRequests, failedRequests, responseTimes, cacheHits, cacheMisses, startTime } = testResults;
            
            document.getElementById('totalReqs').textContent = totalRequests;
            document.getElementById('failedReqs').textContent = failedRequests;
            
            const successRate = totalRequests > 0 ? ((successfulRequests / totalRequests) * 100).toFixed(2) : 0;
            document.getElementById('successRate').textContent = successRate + '%';
            
            const avgTime = responseTimes.length > 0 
                ? (responseTimes.reduce((a, b) => a + b, 0) / responseTimes.length).toFixed(2)
                : 0;
            document.getElementById('avgTime').innerHTML = avgTime + '<span class="unit">ms</span>';
            
            const totalCacheRequests = cacheHits + cacheMisses;
            const hitRatio = totalCacheRequests > 0 ? ((cacheHits / totalCacheRequests) * 100).toFixed(2) : 0;
            document.getElementById('cacheHitRatio').textContent = hitRatio + '%';
            
            if (startTime) {
                const elapsed = (Date.now() - startTime) / 1000;
                const rps = elapsed > 0 ? (totalRequests / elapsed).toFixed(2) : 0;
                document.getElementById('reqPerSec').textContent = rps;
            }
        }

        // Utility: Make request and track
        async function makeRequest(url, options = {}) {
            const startTime = performance.now();
            
            try {
                const response = await fetch(url, options);
                const endTime = performance.now();
                const responseTime = endTime - startTime;
                
                testResults.totalRequests++;
                testResults.responseTimes.push(responseTime);
                
                // Check cache headers
                const age = response.headers.get('age');
                const cacheControl = response.headers.get('cache-control');
                const xCache = response.headers.get('x-cache');
                const cfCacheStatus = response.headers.get('cf-cache-status');
                
                if (age || xCache?.includes('HIT') || cfCacheStatus === 'HIT') {
                    testResults.cacheHits++;
                } else {
                    testResults.cacheMisses++;
                }
                
                if (response.ok) {
                    testResults.successfulRequests++;
                    return { success: true, responseTime, status: response.status, cached: !!age };
                } else {
                    testResults.failedRequests++;
                    testResults.errors.push({ url, status: response.status, statusText: response.statusText });
                    return { success: false, responseTime, status: response.status };
                }
            } catch (error) {
                const endTime = performance.now();
                const responseTime = endTime - startTime;
                
                testResults.totalRequests++;
                testResults.failedRequests++;
                testResults.errors.push({ url, error: error.message });
                
                return { success: false, responseTime, error: error.message };
            }
        }

        // Test: Read news list
        async function testReadNews() {
            const apiUrl = document.getElementById('apiUrl').value;
            const result = await makeRequest(`${apiUrl}/news`);
            
            if (result.success) {
                log(`‚úÖ GET /news - ${result.responseTime.toFixed(2)}ms ${result.cached ? '[CACHED]' : '[ORIGIN]'}`, 'success');
            } else {
                log(`‚ùå GET /news failed - ${result.status || result.error}`, 'error');
            }
            
            return result;
        }

        // Test: Read single article
        async function testReadArticle(id = '1') {
            const apiUrl = document.getElementById('apiUrl').value;
            const result = await makeRequest(`${apiUrl}/news/${id}`);
            
            if (result.success) {
                log(`‚úÖ GET /news/${id} - ${result.responseTime.toFixed(2)}ms ${result.cached ? '[CACHED]' : '[ORIGIN]'}`, 'success');
            } else {
                log(`‚ùå GET /news/${id} failed - ${result.status || result.error}`, 'error');
            }
            
            return result;
        }

        // Test: Create article
        async function testCreateArticle() {
            const apiUrl = document.getElementById('apiUrl').value;
            const authToken = document.getElementById('authToken').value;
            
            const data = {
                title: `Test Article ${Date.now()}`,
                content: `This is a test article created at ${new Date().toISOString()}`,
                author: 'Stress Test Tool'
            };
            
            const options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                },
                body: JSON.stringify(data)
            };
            
            const result = await makeRequest(`${apiUrl}/news`, options);
            
            if (result.success) {
                log(`‚úÖ POST /news - ${result.responseTime.toFixed(2)}ms [CREATED]`, 'success');
            } else {
                log(`‚ùå POST /news failed - ${result.status || result.error}`, 'error');
            }
            
            return result;
        }

        // Main test runner
        async function startTest() {
            if (testRunning) {
                log('‚ö†Ô∏è Test already running!', 'warning');
                return;
            }
            
            testRunning = true;
            testResults.startTime = Date.now();
            
            const totalRequests = parseInt(document.getElementById('totalRequests').value);
            const concurrent = parseInt(document.getElementById('concurrent').value);
            const delay = parseInt(document.getElementById('delay').value);
            const testType = document.getElementById('testType').value;
            
            log(`üöÄ Starting stress test: ${totalRequests} requests, ${concurrent} concurrent`, 'info');
            log(`üìç Test type: ${testType}`, 'info');
            
            let completed = 0;
            
            while (completed < totalRequests && testRunning) {
                const batch = Math.min(concurrent, totalRequests - completed);
                const promises = [];
                
                for (let i = 0; i < batch; i++) {
                    switch (testType) {
                        case 'read':
                            promises.push(testReadNews());
                            break;
                        case 'single':
                            promises.push(testReadArticle(Math.floor(Math.random() * 100)));
                            break;
                        case 'create':
                            promises.push(testCreateArticle());
                            break;
                        case 'mixed':
                            const rand = Math.random();
                            if (rand < 0.6) promises.push(testReadNews());
                            else if (rand < 0.9) promises.push(testReadArticle(Math.floor(Math.random() * 100)));
                            else promises.push(testCreateArticle());
                            break;
                        case 'cache-bust':
                            promises.push(makeRequest(`${document.getElementById('apiUrl').value}/news?_=${Date.now()}`));
                            break;
                        default:
                            promises.push(testReadNews());
                    }
                }
                
                await Promise.all(promises);
                completed += batch;
                
                const progress = (completed / totalRequests) * 100;
                document.getElementById('progressBar').style.width = progress + '%';
                document.getElementById('progressBar').textContent = progress.toFixed(0) + '%';
                
                updateMetrics();
                
                if (delay > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            
            testResults.endTime = Date.now();
            testRunning = false;
            
            const duration = ((testResults.endTime - testResults.startTime) / 1000).toFixed(2);
            log(`‚úÖ Test completed in ${duration}s`, 'success');
            log(`üìä Success rate: ${((testResults.successfulRequests / testResults.totalRequests) * 100).toFixed(2)}%`, 'info');
            log(`üìä Cache hit ratio: ${((testResults.cacheHits / (testResults.cacheHits + testResults.cacheMisses)) * 100).toFixed(2)}%`, 'info');
        }

        function stopTest() {
            testRunning = false;
            log('‚èπÔ∏è Test stopped by user', 'warning');
        }

        function resetMetrics() {
            testResults = {
                totalRequests: 0,
                successfulRequests: 0,
                failedRequests: 0,
                responseTimes: [],
                cacheHits: 0,
                cacheMisses: 0,
                errors: [],
                startTime: null,
                endTime: null,
            };
            
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressBar').textContent = '0%';
            updateMetrics();
            
            log('üîÑ Metrics reset', 'info');
        }

        function clearLogs() {
            document.getElementById('log').innerHTML = '<div class="info">[INFO] Logs cleared.</div>';
        }

        async function testRedisCache() {
            log('üß™ Testing Redis cache layer...', 'info');
            await testReadNews();
            await new Promise(r => setTimeout(r, 100));
            await testReadNews();
            updateMetrics();
        }

        async function testCDNCache() {
            log('üß™ Testing CDN cache layer...', 'info');
            const frontendUrl = document.getElementById('frontendUrl').value;
            await makeRequest(frontendUrl);
            await new Promise(r => setTimeout(r, 100));
            await makeRequest(frontendUrl);
            updateMetrics();
        }

        async function testBrowserCache() {
            log('üß™ Testing browser cache layer...', 'info');
            const apiUrl = document.getElementById('apiUrl').value;
            await makeRequest(`${apiUrl}/_next/static/test.js`);
            updateMetrics();
        }

        function exportResults() {
            const json = JSON.stringify(testResults, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `stress-test-${Date.now()}.json`;
            a.click();
            log('üìä Results exported to JSON', 'success');
        }

        // Initialize
        updateMetrics();
    </script>
</body>
</html>
